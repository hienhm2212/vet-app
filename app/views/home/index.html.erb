<div class="container-fluid mt-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 mb-1">
            <i class="bi bi-speedometer2 text-primary me-2"></i>
            Bảng điều khiển
          </h1>
          <p class="text-muted mb-0">Tổng quan về hoạt động phòng khám thú y</p>
        </div>
        <div class="text-end">
          <p class="text-muted mb-0">
            <i class="bi bi-calendar3 me-1"></i>
            <%= Time.current.strftime("%A, %d/%m/%Y") %>
          </p>
          <p class="text-muted mb-0">
            <i class="bi bi-clock me-1"></i>
            <%= Time.current.strftime("%H:%M") %>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="stat-card card border-0 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon mb-3">
            <i class="bi bi-people-fill text-white fs-1"></i>
          </div>
          <h3 class="card-title text-white fw-bold mb-1"><%= @total_owners %></h3>
          <p class="card-text text-white-75 mb-0">Chủ nuôi</p>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="stat-card success card border-0 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon mb-3">
            <i class="bi bi-heart-pulse-fill text-white fs-1"></i>
          </div>
          <h3 class="card-title text-white fw-bold mb-1"><%= @total_patients %></h3>
          <p class="card-text text-white-75 mb-0">Bệnh nhân</p>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="stat-card info card border-0 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon mb-3">
            <i class="bi bi-calendar-check-fill text-white fs-1"></i>
          </div>
          <h3 class="card-title text-white fw-bold mb-1"><%= @total_appointments %></h3>
          <p class="card-text text-white-75 mb-0">Lịch hẹn</p>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="stat-card warning card border-0 shadow-sm h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon mb-3">
            <i class="bi bi-file-earmark-text-fill text-white fs-1"></i>
          </div>
          <h3 class="card-title text-white fw-bold mb-1"><%= @total_invoices %></h3>
          <p class="card-text text-white-75 mb-0">Hóa đơn</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <div class="col-lg-8 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-graph-up text-primary me-2"></i>
            Doanh thu 7 ngày qua
          </h5>
        </div>
        <div class="card-body">
          <canvas id="salesChart" height="100"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-pie-chart text-success me-2"></i>
            Trạng thái lịch hẹn
          </h5>
        </div>
        <div class="card-body">
          <canvas id="appointmentsChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts and Recent Activities -->
  <div class="row mb-4">
    <!-- Low Inventory Alerts -->
    <div class="col-lg-6 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
            Cảnh báo tồn kho
          </h5>
        </div>
        <div class="card-body p-0">
          <% if @low_stock_products.any? %>
            <div class="list-group list-group-flush">
              <% @low_stock_products.each do |product| %>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1"><%= product.name %></h6>
                    <small class="text-muted"><%= product.category %></small>
                  </div>
                  <div class="text-end">
                    <span class="badge <%= product.stock == 0 ? 'bg-danger' : 'bg-warning' %>">
                      <%= product.stock %> đơn vị
                    </span>
                    <%= link_to 'Xem', product_path(product), class: 'btn btn-sm btn-outline-primary ms-2' %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-check-circle text-success fs-1"></i>
              <p class="text-muted mt-2">Tất cả sản phẩm đều có đủ tồn kho!</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Recent Activities -->
    <div class="col-lg-6 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-activity text-info me-2"></i>
            Hoạt động gần đây
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <% @recent_appointments.each do |appointment| %>
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6 class="mb-1">
                      <i class="bi bi-calendar-event text-primary me-1"></i>
                      Lịch hẹn mới
                    </h6>
                    <p class="mb-1">
                      <strong><%= appointment.patient.name %></strong> 
                      (<%= appointment.patient.owner.name %>)
                    </p>
                    <small class="text-muted">
                      <%= format_datetime_vn(appointment.scheduled_at) %> - 
                      <%= appointment.display_type %>
                    </small>
                  </div>
                  <span class="badge <%= appointment.status == 'scheduled' ? 'bg-primary' : 
                                       appointment.status == 'completed' ? 'bg-success' : 'bg-secondary' %>">
                    <%= appointment.display_status %>
                  </span>
                </div>
              </div>
            <% end %>
            
            <% @recent_invoices.each do |invoice| %>
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6 class="mb-1">
                      <i class="bi bi-file-earmark-text text-success me-1"></i>
                      Hóa đơn mới
                    </h6>
                    <p class="mb-1">
                      <strong><%= invoice.appointment.patient.name %></strong>
                      (<%= invoice.appointment.patient.owner.name %>)
                    </p>
                    <small class="text-muted">
                      <%= format_vnd(invoice.total_amount) %> - 
                      <%= format_datetime_vn(invoice.created_at) %>
                    </small>
                  </div>
                  <span class="badge <%= invoice.payment_status == 'paid' ? 'bg-success' : 'bg-warning' %>">
                    <%= invoice.display_status %>
                  </span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Today's Appointments and Quick Stats -->
  <div class="row mb-4">
    <!-- Today's Appointments -->
    <div class="col-lg-8 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-calendar-day text-primary me-2"></i>
            Lịch hẹn hôm nay
          </h5>
        </div>
        <div class="card-body p-0">
          <% if @today_appointments.any? %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Thời gian</th>
                    <th>Bệnh nhân</th>
                    <th>Chủ nuôi</th>
                    <th>Loại</th>
                    <th>Trạng thái</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @today_appointments.each do |appointment| %>
                    <tr>
                      <td><%= format_time_vn(appointment.scheduled_at) %></td>
                      <td>
                        <strong><%= appointment.patient.name %></strong>
                        <br><small class="text-muted"><%= appointment.patient.species %></small>
                      </td>
                      <td><%= appointment.patient.owner.name %></td>
                      <td><%= appointment.display_type %></td>
                      <td>
                        <span class="badge <%= appointment.status == 'scheduled' ? 'bg-primary' : 
                                             appointment.status == 'completed' ? 'bg-success' : 'bg-secondary' %>">
                          <%= appointment.display_status %>
                        </span>
                      </td>
                      <td>
                        <%= link_to 'Xem', owner_patient_appointment_path(appointment.patient.owner, appointment.patient, appointment), 
                            class: 'btn btn-sm btn-outline-primary' %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-calendar-x text-muted fs-1"></i>
              <p class="text-muted mt-2">Không có lịch hẹn nào hôm nay</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="col-lg-4 mb-3">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-speedometer text-info me-2"></i>
            Thống kê nhanh
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="border rounded p-3">
                <h4 class="text-primary mb-1"><%= @pending_appointments %></h4>
                <small class="text-muted">Chờ khám</small>
              </div>
            </div>
            <div class="col-6 mb-3">
              <div class="border rounded p-3">
                <h4 class="text-success mb-1"><%= @completed_appointments %></h4>
                <small class="text-muted">Đã hoàn thành</small>
              </div>
            </div>
            <div class="col-6 mb-3">
              <div class="border rounded p-3">
                <h4 class="text-warning mb-1"><%= @pending_payments %></h4>
                <small class="text-muted">Chờ thanh toán</small>
              </div>
            </div>
            <div class="col-6 mb-3">
              <div class="border rounded p-3">
                <h4 class="text-info mb-1"><%= @total_products %></h4>
                <small class="text-muted">Sản phẩm</small>
              </div>
            </div>
          </div>
          
          <!-- Revenue Summary -->
          <div class="mt-3 p-3 bg-light rounded">
            <h6 class="text-muted mb-2">Doanh thu 30 ngày</h6>
            <h4 class="text-success mb-1"><%= format_vnd(@total_revenue_30_days) %></h4>
            <small class="text-muted"><%= @total_sales_count_30_days %> hóa đơn</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Selling Products -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-trophy text-warning me-2"></i>
            Sản phẩm bán chạy
          </h5>
        </div>
        <div class="card-body p-0">
          <% if @top_selling_products.any? %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Sản phẩm</th>
                    <th>Danh mục</th>
                    <th>Đã bán</th>
                    <th>Tồn kho</th>
                    <th>Giá</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @top_selling_products.each_with_index do |product, index| %>
                    <tr>
                      <td>
                        <% if index == 0 %>
                          <i class="bi bi-trophy-fill text-warning"></i>
                        <% elsif index == 1 %>
                          <i class="bi bi-trophy-fill text-secondary"></i>
                        <% elsif index == 2 %>
                          <i class="bi bi-trophy-fill text-bronze"></i>
                        <% else %>
                          <span class="text-muted"><%= index + 1 %></span>
                        <% end %>
                      </td>
                      <td>
                        <strong><%= product.name %></strong>
                        <br><small class="text-muted"><%= product.barcode %></small>
                      </td>
                      <td><%= product.category %></td>
                      <td>
                        <span class="badge bg-success"><%= product.total_sold %></span>
                      </td>
                      <td>
                        <span class="<%= product.stock <= 10 ? 'text-danger' : 'text-success' %>">
                          <%= product.stock %>
                        </span>
                      </td>
                      <td><%= format_vnd(product.price) %></td>
                      <td>
                        <%= link_to 'Xem', product_path(product), class: 'btn btn-sm btn-outline-primary' %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-box text-muted fs-1"></i>
              <p class="text-muted mt-2">Chưa có dữ liệu bán hàng</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function initDashboardCharts() {
  const salesEl = document.getElementById('salesChart');
  const appointmentsEl = document.getElementById('appointmentsChart');

  if (!salesEl || !appointmentsEl || typeof Chart === 'undefined') { return; }

  // Destroy existing charts if re-initialized by Turbo navigation
  if (window.__salesChartInstance) { window.__salesChartInstance.destroy(); }
  if (window.__appointmentsChartInstance) { window.__appointmentsChartInstance.destroy(); }

  // Sales Chart
  const salesCtx = salesEl.getContext('2d');
  const salesData = <%= raw @daily_sales.to_json %>;

  const salesLabels = [];
  const salesValues = [];

  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    salesLabels.push(date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
    salesValues.push(salesData[dateStr] || 0);
  }

  window.__salesChartInstance = new Chart(salesCtx, {
    type: 'line',
    data: {
      labels: salesLabels,
      datasets: [{
        label: 'Doanh thu (VND)',
        data: salesValues,
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
              }).format(value);
            }
          }
        }
      }
    }
  });

  // Appointments Chart
  const appointmentsCtx = appointmentsEl.getContext('2d');
  const appointmentsData = <%= raw @appointments_by_status.to_json %>;

  const statusLabels = {
    'scheduled': 'Chờ khám',
    'in_progress': 'Đang khám',
    'completed': 'Hoàn thành',
    'cancelled': 'Đã hủy'
  };

  const statusColors = {
    'scheduled': '#0d6efd',
    'in_progress': '#ffc107',
    'completed': '#198754',
    'cancelled': '#6c757d'
  };

  const labels = [];
  const data = [];
  const colors = [];

  Object.keys(appointmentsData).forEach(status => {
    labels.push(statusLabels[status] || status);
    data.push(appointmentsData[status]);
    colors.push(statusColors[status] || '#6c757d');
  });

  window.__appointmentsChartInstance = new Chart(appointmentsCtx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

document.addEventListener('DOMContentLoaded', initDashboardCharts);
document.addEventListener('turbo:load', initDashboardCharts);
</script>
